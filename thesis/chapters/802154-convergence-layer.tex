\chapter{802.15.4 Convergence layer}
\label{802154layer}
\section{Interface with the linux ieee802154 Stack}

The communication bnetween the 802.15.4 convergence layer of IBR-DTN and the
linux ieee802154 stack is done over to seperate channels. One is used for
signalling and configuration and is handled over the kernel netlink mechnism.
The second is used for the actual data transport and is exposed as standard
socket interface. The listing below shows the usage of the socket interface. As
domain AF\_IEEE802154 is used and a struct sockaddr\_ieee802154 fullfiles the
need for an adjustment of the addressing scheme as well as the usage of a PAN
ID. The type is the known SOCK\_DGRAM and the default protocol is used. In the
convergence layer we use the socket interface to transmit the data to the actual
peer. It is also partially wrapped into a UnicastSocketLOWPAN class.

\begin{lstlisting}
	...

        int sd;
        struct sockaddr_ieee802154 a;

        sd = socket(PF_IEEE802154, SOCK_DGRAM, 0);

        a.family = AF_IEEE802154;
        a.addr.addr_type = IEEE802154_ADDR_SHORT;
        a.addr.pan_id = 0x0780;

	a.addr.short_addr = 0x0001;
	bind(sd, (struct sockaddr *)&a, sizeof(a));

        a.addr.short_addr = 0x8001;
	connect(sd, (struct sockaddr *)&a, sizeof(a));

	...
\end{lstlisting}

Over netlink it is possible to send different commands and set attributes of the
ieee802154 stack. The attributes conatin among others informations about the
address of the interface, its index, PAN ID, channel and more. The commands
allow to get and set the differen attributes, trigger a association, requesta a
scan and others. The given functionality is used to implemet the basic
utilitiues for configuration as well as a PAN coordinator bundled together in
the lowpan-tools package. In IBR-DTN we only use a small subset of this
functionality. We ask for the short address when binding to the socket to
receive incoming data. In the future we could also ask for the PAN ID and the
hardware address to be more flexible. For the basic network setup we rely on the
lowpan-tools utilities. With izcoordinator we set up a PAN coordinator on one
node while we use iz to associate to this PAN from the other node. The PAN ID is
given to bopth tools on the commandline and the coordinator hands the
associating node a ahort address. With this basic configuration, which can
somehwat be compared to a dhcp server and client, we start dtnd and are ready to
transmit and receive bundles.

\section{Addressing}

The specification for Low-Rate Wireless Personal Area Networks specifies to
types of addresses. All devices have an unique 64 bit extended address.
Additional they can have a 16 bit short address that can be different depending
on the PAN. The short address is supplied by the PAN coordinator.

\section{Fragmentation}

The maximal packet size in 802.15.4 is about 127 byte. Substracting the header
and other needed data we can transport about 115 byte of actual payload in a
packet. So far IBR-DTN was build around the IP/TCP/UDP family which normally has
a maximal transfer size of 1500 byte.

The header size of the bundle protocol is not fixed but variable depending on
the transported data and enabled options. It is as well possible that the header
size is greater then the 115 byte payload we could offer with 802.15.4. The
draft FIXME:CITE for a TCP convergence layer protocol could help here as it
defines a data transmission divided into several segments. Even the bundle
header could be split into several segments this way and build together on the
receiving side.

\section{Related Work}

While DTN is getting more popular for research there are only a few research
projects then combine DTN with sensor network technologies like IEEE 802.15.4.
That is not surprising if one keeps in mind that the DTN architecture is is
complex and memory as well as bandwidth consuming. Both resources that are scare
on sensor network platforms.

Two projects are aiming to explore this area of research. One of them is the
TinyOS based DTNLite \cite{dtnlite}. It is loosely based on the DTN overlay
architecture. To deliver custody transfer  over the overlay they use techniques
like asynchronous message delivery. The concept is targeted at data collection
applications which need to reach a central station for the collection over the
network.

Contiki DTN

